<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>কলিকাতা গ্রামোফোন — Bangali Gramophone</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;500;700&family=Cinzel:wght@600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c0a0a; --bg2:#131010; --ink:#f7efe3; --muted:#d6c9b6;
    --wood1:#3e2215; --wood2:#6a3d22; --brass1:#cfb163; --brass2:#9b7b3d;
    --accent:#b44c4c; --stroke:#2b1a12; --glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 10% -10%, #2a1b14 0, transparent 60%),
      linear-gradient(180deg,var(--bg2),var(--bg) 55%, var(--bg2));
    font:14px/1.6 "Noto Serif Bengali", system-ui;
    overflow:hidden;
  }

  .alpana:before,.alpana:after{
    content:""; position:fixed; inset:18px; border:1px dashed rgba(255,255,255,.12); border-radius:18px; pointer-events:none;
  }
  .alpana:after{
    inset:10px; border-style:solid; border-width:1px; border-image: radial-gradient(circle,#d9caaa 10%,transparent 35%) 30 round;
    opacity:.25;
  }

  header{
    position:relative; z-index:3; display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px 14px; border-bottom:1px solid #3a2417;
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02)); backdrop-filter:blur(6px) saturate(120%);
  }
  .brand{display:flex; align-items:center; gap:10px}
  .seal{
    width:30px; height:30px; border-radius:50%;
    background:radial-gradient(circle at 35% 35%, var(--brass1), var(--brass2) 70%);
    box-shadow:0 0 18px rgba(207,177,99,.25), inset 0 0 10px rgba(0,0,0,.5);
    position:relative; overflow:hidden;
  }
  .seal:after{content:""; position:absolute; inset:6px; border-radius:50%; border:2px solid rgba(0,0,0,.45)}
  h1{margin:0; font:700 18px/1 "Noto Serif Bengali", serif; letter-spacing:.2px}
  .pill{font-size:12px; color:var(--muted)}

  input,button{
    background:#221610; color:var(--ink); border:1px solid #513320; border-radius:12px; padding:8px 10px; font:inherit;
  }
  button{background:var(--accent); color:#fff; border:0; font-weight:700; cursor:pointer}
  button.ghost{background:#221610; color:var(--ink); border:1px solid #513320}

  .wrap{
    display:grid; grid-template-columns:360px 1fr; gap:16px; padding:14px;
    height:calc(100% - 58px); position:relative; z-index:2;
  }
  aside{
    background:var(--glass); border:1px solid #3d2719; border-radius:16px; padding:12px; overflow:auto; min-height:0;
    box-shadow:0 20px 60px rgba(0,0,0,.4) inset;
  }
  .group{border:1px solid #3d2719; border-radius:14px; padding:10px; margin-bottom:10px; background:rgba(0,0,0,.20)}
  .group h3{margin:0 0 8px 0; font-size:13px; color:#eadcc6}

  main{
    background:rgba(0,0,0,.25); border:1px solid #3d2719; border-radius:16px; overflow:hidden; position:relative;
  }

  .stage{position:absolute; inset:0; display:grid; place-items:center; padding:16px}
  .box{
    width:1100px; max-width:100%; aspect-ratio:16/9; display:grid; grid-template-columns:1.1fr .9fr; gap:20px;
    background:linear-gradient(135deg,var(--wood1),var(--wood2));
    border-radius:20px; padding:18px; box-shadow:inset 0 0 0 2px rgba(0,0,0,.35), 0 22px 80px rgba(0,0,0,.55);
    border:1px solid #2b1a12;
  }
  .deck{
    background:linear-gradient(180deg,#231812,#20150f); border:1px solid #3f2a1c; border-radius:16px; padding:16px;
    display:grid; grid-template-columns:1.2fr .8fr; gap:16px;
  }

  .tt{position:relative; width:100%; aspect-ratio:1; border-radius:16px; display:grid; place-items:center;
      background:radial-gradient(circle at 50% 45%, #172336, #0f1a2b 60%); border:1px solid #33405c;}
  .felt{position:absolute; inset:5%; background:radial-gradient(circle at 30% 30%, #1a3648, #0e2435 70%); border-radius:50%}
  .record{position:absolute; inset:10%; border-radius:50%;
          background:radial-gradient(circle at 50% 50%, #222 0 46%, #111 48% 100%); box-shadow:inset 0 0 60px rgba(0,0,0,.7)}
  .label{position:absolute; width:26%; height:26%; border-radius:50%;
         background:radial-gradient(circle at 40% 40%, var(--brass1), var(--brass2)); box-shadow:inset 0 0 18px rgba(0,0,0,.55)}
  .spindle{position:absolute; width:10px; height:10px; border-radius:50%; background:#ddd; box-shadow:0 0 0 2px #555 inset}
  .arm{position:absolute; right:-4%; top:4%; width:42%; height:42%; pointer-events:none}
  .arm svg{width:100%; height:100%}

  .horn{
    position:relative; background:radial-gradient(circle at 30% 30%, var(--brass1), var(--brass2) 65%);
    border:1px solid rgba(0,0,0,.55); border-radius:18px; padding:12px;
    box-shadow:inset 0 0 50px rgba(0,0,0,.55), 0 16px 50px rgba(0,0,0,.45);
  }
  .horn:after{
    content:"শ্রী"; position:absolute; top:10px; right:14px; font:700 20px/1 "Noto Serif Bengali"; color:rgba(0,0,0,.45);
    text-shadow:0 1px 0 rgba(255,255,255,.12);
  }
  .flare{
    width:100%; height:100%;
    background:
      conic-gradient(from 0deg, #b2873c 0 6%, #c8a457 6% 12%, #8d6c33 12% 18%, #c8a457 18% 24%, #b2873c 24% 30%, #c8a457 30% 36%, #8d6c33 36% 42%, #c8a457 42% 48%, #b2873c 48% 54%, #c8a457 54% 60%, #8d6c33 60% 66%, #c8a457 66% 72%, #b2873c 72% 78%, #c8a457 78% 84%, #8d6c33 84% 90%, #c8a457 90% 96%, #b2873c 96% 100%);
    mask: radial-gradient(closest-side, black 62%, transparent 63%);
    border-radius:14px;
  }

  .panel{
    background:#1f1611; border:1px solid #3d2719; border-radius:14px; padding:12px; color:#e8dcc8;
  }
  .brand{
    font:700 20px/1 "Noto Serif Bengali"; letter-spacing:.3px; color:#f2e5cf; margin-bottom:6px
  }
  .sub{font-size:12px; color:#d4c2ac}
  .row{display:flex; gap:8px; align-items:center; margin:8px 0}
  .note{font-size:12px; color:#d4c2ac}

  .knob{width:74px;height:74px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #c8b077, #745b30);
        border:1px solid rgba(0,0,0,.55); box-shadow:inset 0 8px 16px rgba(0,0,0,.55), 0 10px 30px rgba(0,0,0,.35);
        position:relative; user-select:none; cursor:pointer}
  .knob:after{content:""; position:absolute; inset:12px; border-radius:50%; background:radial-gradient(circle at 60% 40%, #8a6f3d, #3b2e16)}
  .dot{position:absolute; width:6px; height:6px; border-radius:50%; background:#111; left:calc(50% - 3px); top:6px}

  .spinning .record{animation:spin 2.46s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body class="alpana">
<header>
  <div class="brand">
    <div class="seal"></div>
    <h1>কলিকাতা গ্রামোফোন</h1>
    <span class="pill" id="status">প্রস্তুত</span>
  </div>
</header>

<div class="wrap">
  <aside>
    <div class="group">
      <h3>YouTube (ব্যাকগ্রাউন্ড)</h3>
      <div class="row">
        <input id="ytUrl" placeholder="YouTube লিংক (https://…)" style="flex:1">
        <button id="ytPlay">চালান</button>
      </div>
      <p class="note">নোট: ব্রাউজার সীমাবদ্ধতার জন্য ইউটিউব অডিওতে আসল ইকিউ/প্রসেসিং করা যায় না। তবু পরিবেশ-শব্দ থাকবে।</p>
    </div>

    <div class="group">
      <h3>অডিও (লোকাল/ডিরেক্ট URL)</h3>
      <div class="row">
        <input id="audUrl" placeholder="mp3/aac/ogg (CORS OK)" style="flex:1">
        <button class="ghost" id="audPlay">চালান</button>
      </div>
      <div class="row">
        <button id="ambBtn" class="ghost">ভিন্টেজ পরিবেশ: বন্ধ</button>
        <button id="stopBtn" class="ghost">বন্ধ</button>
        <button id="muteBtn" class="ghost">মিউট</button>
      </div>
    </div>

    <div class="group">
      <h3>শব্দ চরিত্র (লোকাল/URL-এ প্রযোজ্য)</h3>
      <div class="row" style="justify-content:space-between">
        <span>Surface noise</span>
        <div class="knob" id="noiseKnob"><span class="dot"></span></div>
      </div>
      <div class="row" style="justify-content:space-between">
        <span>Horn depth</span>
        <div class="knob" id="hornKnob"><span class="dot"></span></div>
      </div>
    </div>
  </aside>

  <main>
    <div class="stage">
      <div class="box">
        <div class="deck">
          <div class="tt" id="tt">
            <div class="felt"></div>
            <div class="record"></div>
            <div class="label"></div>
            <div class="spindle"></div>
            <div class="arm">
              <svg viewBox="0 0 200 200" fill="none">
                <path d="M30 40 C 120 40, 120 140, 180 140" stroke="#d5bd82" stroke-width="10" stroke-linecap="round"/>
                <rect x="172" y="132" width="20" height="16" rx="3" fill="#1a1a1a" stroke="#555" />
              </svg>
            </div>
          </div>
          <div class="panel">
            <div class="brand">কলিকাতা গ্রামোফোন কোম্পানি</div>
            <div class="sub">শ্রুতি-সুধা · ৭৮ আরপিএম</div>
            <div class="row">
              <button id="powerBtn">বিদ্যুৎ</button>
              <button class="ghost" id="startBtn">শুরু</button>
              <button class="ghost" id="pauseBtn">বিরতি</button>
            </div>
            <div class="pill" id="playState">বন্ধ</div>
          </div>
        </div>
        <div class="horn"><div class="flare"></div></div>
      </div>
    </div>
  </main>
</div>

<!-- Hidden players -->
<div id="ytHolder" style="position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden;"></div>
<audio id="audio" crossorigin="anonymous"></audio>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const statusEl = $('#status');
  const tt = $('#tt');
  const playState = $('#playState');
  const audio = $('#audio');

  let powered = true;
  $('#powerBtn').onclick = () => { powered = !powered; statusEl.textContent = powered ? 'প্রস্তুত' : 'বন্ধ'; if (!powered) stopAll(); };
  $('#startBtn').onclick = () => { if (!powered) return; startSpin(); resume(); };
  $('#pauseBtn').onclick = () => { pauseAll(); stopSpin(false); };
  $('#stopBtn').onclick = () => stopAll();

  function startSpin() { tt.classList.add('spinning'); }
  function stopSpin(full = true) { if (full) tt.classList.remove('spinning'); }
  function setState(t) { playState.textContent = t; }
  function setStatus(t) { statusEl.textContent = t; }

  /* ===== Robust YouTube with Fallback ===== */
  let ytReady = false, ytPlayer = null, ytActive = false, ytBusy = false, ytFailed = false;

  function ytIdFromUrl(u) {
    try {
      const url = new URL(u);
      if (url.hostname.includes('youtu.be')) return url.pathname.slice(1);
      if (url.searchParams.get('v')) return url.searchParams.get('v');
      if (url.hostname.includes('youtube.com') && url.pathname.startsWith('/shorts/')) return url.pathname.split('/')[2];
    } catch (e) {}
    return null;
  }

  function loadYT() {
    return new Promise((resolve, reject) => {
      if (window.YT && YT.Player) { ytReady = true; return resolve(); }
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      tag.async = true;
      tag.onerror = () => reject(new Error("YouTube API failed to load"));
      document.head.appendChild(tag);

      window.onYouTubeIframeAPIReady = () => { ytReady = true; resolve(); };

      const poll = setInterval(() => {
        if (window.YT && YT.Player) { clearInterval(poll); ytReady = true; resolve(); }
      }, 200);

      setTimeout(() => { if (!ytReady) { clearInterval(poll); reject(new Error("YouTube API timed out")); } }, 10000);
    });
  }

  async function ensureYTPlayer() {
    if (!ytReady) { setStatus("YouTube লোড হচ্ছে…"); await loadYT(); }
    if (!ytPlayer) {
      ytPlayer = new YT.Player('ytHolder', {
        width: 1, height: 1,
        playerVars: {
          playsinline: 1, controls: 0, modestbranding: 1,
          origin: (location.origin.startsWith('http') ? location.origin : undefined)
        },
        events: {
          onReady: () => setStatus("YouTube প্রস্তুত"),
          onError: (e) => {
            const code = e?.data;
            ytFailed = true;
            setStatus("YouTube error: " + code);
            if (code === 101 || code === 150) {
              alert("এই ভিডিও এম্বেড-অ্যালাউড নয় (YT error " + code + "). অন্য ভিডিও দিন।");
            } else {
              alert("YouTube embed error (" + code + "). Fallback চালু করছি।");
            }
          },
          onStateChange: (ev) => {
            if (ev.data === YT.PlayerState.PLAYING) {
              ytActive = true; startSpin(); setState('চলছে (YouTube)'); ambienceOn(true);
            }
            if (ev.data === YT.PlayerState.PAUSED) {
              setState('বিরতি'); ambienceOn(false);
            }
            if (ev.data === YT.PlayerState.ENDED) {
              stopSpin(); setState('শেষ'); ambienceOn(false);
            }
          }
        }
      });
    }
    return ytPlayer;
  }

  function fallbackEmbed(videoId) {
    const holder = document.getElementById('ytHolder');
    holder.innerHTML = '';
    const ifr = document.createElement('iframe');
    ifr.width = 1; ifr.height = 1;
    ifr.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&playsinline=1&rel=0&modestbranding=1&mute=1`;
    ifr.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture');
    ifr.style.border = '0';
    holder.appendChild(ifr);
    setTimeout(() => {
      try {
        ifr.contentWindow.postMessage(JSON.stringify({ event: 'command', func: 'unMute', args: [] }), '*');
      } catch (e) {}
    }, 1200);
    ytActive = true; startSpin(); setState('চলছে (YouTube fallback)'); ambienceOn(true);
  }

  document.getElementById('ytPlay').onclick = async () => {
    if (ytBusy) return; ytBusy = true;
    try {
      if (!powered) return;
      const link = (document.getElementById('ytUrl').value || '').trim();
      const id = ytIdFromUrl(link);
      if (!id) return alert('সঠিক YouTube লিংক দিন');

      try { audio.pause(); } catch (e) {}

      setStatus("ভিডিও লোড হচ্ছে…");
      ytFailed = false;

      try {
        const p = await ensureYTPlayer();
        p.mute();
        p.loadVideoById(id);
        await p.playVideo();
        setTimeout(() => { try { p.unMute(); } catch (e) {} }, 400);
      } catch (apiErr) {
        fallbackEmbed(id);
      }
    } finally {
      ytBusy = false;
    }
  };

  /* ===== Local/Direct audio with light ambience (horn+hiss) ===== */
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaElementSource(audio);

  const convolver = ctx.createConvolver(); convolver.normalize = true;
  convolver.buffer = makeHornIR(ctx, 1.2);
  const mainGain = ctx.createGain(); mainGain.gain.value = 1.0;
  const hiss = ctx.createGain(); hiss.gain.value = 0.0;

  src.connect(convolver); convolver.connect(mainGain); mainGain.connect(ctx.destination);
  hiss.connect(ctx.destination);

  const noiseBuf = makeNoiseBuffer(ctx, 2.0);
  const noise = ctx.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; noise.start();
  const hissBP = ctx.createBiquadFilter(); hissBP.type = 'bandpass'; hissBP.frequency.value = 3200; hissBP.Q.value = .8;
  noise.connect(hissBP); hissBP.connect(hiss);

  knob($('#noiseKnob'), v => { hiss.gain.value = v * 0.18; });
  knob($('#hornKnob'), v => { convolver.buffer = makeHornIR(ctx, 0.7 + v * 1.6); mainGain.gain.value = 1.0 - v * 0.25; });

  $('#audPlay').onclick = () => {
    if (!powered) return;
    const u = $('#audUrl').value.trim();
    if (!u) { alert('অডিও URL দিন'); return; }
    try { ytPlayer?.stopVideo(); } catch (e) {}
    audio.src = u; audio.load();
    audio.play().then(() => {
      ctx.resume();
      startSpin(); setState('চলছে (লোকাল/URL)');
      ambienceOn(true);
    }).catch(() => alert('Autoplay ব্লক—Start টিপে চালান'));
  };

  let muted = false;
  $('#muteBtn').onclick = () => {
    muted = !muted; audio.muted = muted; try { muted ? ytPlayer?.mute() : ytPlayer?.unMute(); } catch (e) {}
  };

  function pauseAll() { audio.pause(); try { ytPlayer?.pauseVideo(); } catch (e) {} setState('বিরতি'); ambienceOn(false); }
  function resume() { audio.play().catch(() => {}); try { ytPlayer?.playVideo(); } catch (e) {} setState('চলছে'); ambienceOn(true); }
  function stopAll() { audio.pause(); audio.currentTime = 0; try { ytPlayer?.stopVideo(); } catch (e) {} stopSpin(); setState('বন্ধ'); ambienceOn(false); }

  /* ===== Ambience ===== */
  const amb = new (window.AudioContext || window.webkitAudioContext)();
  const ambGain = amb.createGain(); ambGain.gain.value = 0.0; ambGain.connect(amb.destination);
  const ambNoise = amb.createBufferSource(); ambNoise.buffer = makeNoiseBuffer(amb, 2.0); ambNoise.loop = true; ambNoise.start();
  const ambBP = amb.createBiquadFilter(); ambBP.type = 'bandpass'; ambBP.frequency.value = 220; ambBP.Q.value = 0.7;
  ambNoise.connect(ambBP); ambBP.connect(ambGain);
  let ambOn = false;
  $('#ambBtn').onclick = () => ambienceOn(!ambOn);
  function ambienceOn(on) {
    ambOn = on;
    $('#ambBtn').textContent = 'ভিন্টেজ পরিবেশ: ' + (on ? 'চালু' : 'বন্ধ');
    ambGain.gain.cancelScheduledValues(amb.currentTime);
    ambGain.gain.linearRampToValueAtTime(on ? 0.06 : 0.0, amb.currentTime + 0.2);
  }

  /* ===== Helpers ===== */
  function knob(el, cb) {
    let dragging = false, startAngle = 0;
    el.addEventListener('mousedown', start); el.addEventListener('touchstart', e => start(e.touches[0]));
    function start(e) {
      dragging = true; e.preventDefault(); startAngle = getAngle(e, el);
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', stop);
      document.addEventListener('touchmove', tmove, { passive: false });
      document.addEventListener('touchend', stop);
    }
    function tmove(ev) { move(ev.touches[0]); ev.preventDefault(); }
    function move(e) {
      if (!dragging) return;
      const a = getAngle(e, el); const d = a - startAngle; startAngle = a;
      const cur = getRotation(el); const next = Math.max(-135, Math.min(135, cur + d));
      el.style.transform = `rotate(${next}deg)`; const v = (next + 135) / 270; cb(v);
    }
    function stop() {
      dragging = false;
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', stop);
      document.removeEventListener('touchmove', tmove);
      document.removeEventListener('touchend', stop);
    }
  }
  function getAngle(e, el) { const r = el.getBoundingClientRect(); const cx = r.left + r.width / 2, cy = r.top + r.height / 2; return Math.atan2(e.clientY - cy, e.clientX - cx) * 180 / Math.PI; }
  function getRotation(el) { const tr = getComputedStyle(el).transform; if (tr === 'none') return 0; const m = /matrix\(([-0-9., ]+)\)/.exec(tr); if (!m) return 0; const a = m[1].split(','); return Math.atan2(a[1], a[0]) * 180 / Math.PI; }

  function makeNoiseBuffer(ctx, dur) {
    const len = Math.floor(ctx.sampleRate * dur); const buf = ctx.createBuffer(1, len, ctx.sampleRate); const d = buf.getChannelData(0);
    for (let i = 0; i < len; i++) { d[i] = (Math.random() * 2 - 1) * 0.33; } return buf;
  }
  function makeHornIR(ctx, seconds) {
    const s = Math.max(.2, Math.min(3.0, seconds));
    const len = Math.floor(ctx.sampleRate * s); const buf = ctx.createBuffer(2, len, ctx.sampleRate);
    const L = buf.getChannelData(0), R = buf.getChannelData(1);
    const freqs = [520, 1180, 2300];
    for (let i = 0; i < len; i++) {
      const t = i / ctx.sampleRate; let v = 0;
      for (let f of freqs) { v += Math.sin(2 * Math.PI * f * t) * Math.exp(-t * (1.6 + f / 2000)); }
      const env = Math.exp(-t * 2.0); const n = (Math.random() * 2 - 1) * 0.03 * env;
      L[i] = (v * 0.16 + n); R[i] = (v * 0.13 + n * 0.9);
    }
    return buf;
  }

  setStatus('প্রস্তুত');
})();
</script>
</body>
</html>
